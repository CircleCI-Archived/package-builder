machine:
  pre:
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo chmod 0755 /usr/bin/docker

  services:
    - docker

  environment:
    pkg_dir: /opt/circleci
    ruby_dir: $pkg_dir/ruby
    python_dir: $pkg_dir/python

dependencies:
  pre:
    - gem install package_cloud
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    - docker pull kimh/package_builder || true
    #- docker build -t kimh/package_builder .
    #- docker push kimh/package_builder

test:
  override:
    - echo 'check_version() { curl "https://$PACKAGECLOUD_TOKEN:@packagecloud.io/api/v1/repos/circleci/trusty/packages.json" | grep $1 | grep $2 >/dev/null 2>&1; }' >> ~/.circlerc
    - echo 'build_pkg() { if ! check_version $1 $2; then ./build-package $1 $2 $pkg_dir/$1/$2; fi; }' >> ~/.circlerc
    - build_pkg ruby 2.0.0-p647
    #- ./build-package ruby 2.0.0-p647 /opt/circleci/ruby/ruby-2.0.0-p647
    #- ./build-package ruby 2.1.8 /opt/circleci/ruby/ruby-2.1.8
    #- ./build-package ruby 2.2.4 /opt/circleci/ruby/ruby-2.2.4
    #- ./build-package ruby 2.3.0 /opt/circleci/ruby/ruby-2.3.0

deployment:
  production:
    branch: master
    commands:
      # Packagecloud doesn't allow to override, so only new packages will be pushed.
      - for p in $(find ./ | grep _amd64.deb); do package_cloud push circleci/circleci/ubuntu/trusty $p; done; true
