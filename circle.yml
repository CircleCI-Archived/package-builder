machine:
  pre:
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo chmod 0755 /usr/bin/docker
  services:
    - docker

dependencies:
  pre:
    - gem install package_cloud

#test:
#  override:
#    - docker build --build-arg version=${version} -t kimh/ruby-build:${version} .:
#        environment:
#          version: 2.2.3
#
#        pwd:
#          ruby/mri/src 
# 
#    - docker run kimh/ruby-build:${version} cat ruby_${version}_amd64.deb > /tmp/ruby_${version}_amd64.deb:
#        environment:
#          version: 2.2.3
#
#    - cp /tmp/ruby_${version}_amd64.deb . && docker build --no-cache --build-arg version=${version} .:
#        environment:
#          version: 2.2.3
#
#        pwd:
#          ruby/mri/test
test:
  override:
    - ./build.sh 2.2.3
        pwd:
          ruby/mri

deployment:
  production:
    branch: master
    commands:
      - package_cloud push circleci/circleci/ubuntu/trusty /tmp/ruby_${version}_amd64.deb
