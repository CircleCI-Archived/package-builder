machine:
  pre:
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo chmod 0755 /usr/bin/docker
    - echo 'check_version() { curl "https://$PACKAGECLOUD_TOKEN:@packagecloud.io/api/v1/repos/circleci/trusty/packages.json" | grep $1 | grep $2 | grep $3  >/dev/null 2>&1; }' >> ~/.circlerc
    - echo 'build_pkg() { if ! check_version $1 $2 $3; then ./build-package $1 $2 $3 $4; fi; }' >> ~/.circlerc
    - echo 'build_ruby() { build_pkg ruby $1 $ruby_release $pkg_dir/ruby/ruby-$1; }' >> ~/.circlerc
    - echo 'build_python() { build_pkg python $1 $python_release $pkg_dir/python/$1; }' >> ~/.circlerc
    - echo 'build_php() { build_pkg php $1 $php_release $pkg_dir/php/$1; }' >> ~/.circlerc
    - echo 'push_pkg() { for p in $(find ./ | grep _amd64.deb); do package_cloud push circleci/trusty/ubuntu/trusty $p; done; true; }' >> ~/.circlerc

  services:
    - docker

  environment:
    pkg_dir: /opt/circleci
    ruby_dir: $pkg_dir/ruby
    python_dir: $pkg_dir/python

    python_release: 1
    ruby_release:   1
    php_release:    1

dependencies:
  pre:
    - gem install package_cloud
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    - docker pull kimh/package_builder || true
    - docker build -t kimh/package_builder .
    - docker push kimh/package_builder

test:
  override:
    - ? case $CIRCLE_NODE_INDEX in
          0)
            build_python 2.6.9 && push_pkg
            build_python 2.7.11 && push_pkg
            build_python 3.1.5 && push_pkg
            push_pkg
            ;;
          1)
            build_python 3.3.6 && push_pkg
            build_python 3.5.1 && push_pkg
            build_python pypy-1.9 && push_pkg
            build_python pypy-2.6.1 && push_pkg
            build_python pypy-4.0.1 && push_pkg
            ;;
          2)
            build_ruby 2.0.0-p647 && push_pkg
            build_ruby 2.1.8 && push_pkg
            build_ruby 2.2.4 && push_pkg
            build_ruby 2.3.0 && push_pkg
            ;;
          3)
            \ # This is comment
            build_php 5.5.31 && push_pkg
            build_php 5.6.17 && push_pkg
            build_php 7.0.2  && phsh_pkg
            ;;
          *)
            exit 0
          ;;
        esac

      : parallel: true

#deployment:
#  production:
#    branch: master
#    commands:
#      # Packagecloud doesn't allow to override, so only new packages will be pushed.
#      - for p in $(find ./ | grep _amd64.deb); do package_cloud push circleci/trusty/ubuntu/trusty $p; done; true
